var mysql=require('mysql');

var db_config = {
  host:'119.23.22.130',
  user:'root',
  password:'123456',
  database:'urbansystem',
  port : 3306
}; 

function connectServer(){
  
  var client = handleDisconnect();
  return client;
  
}

function handleDisconnect() {
  connection = mysql.createConnection(db_config); // Recreate the connection, since
                                                  // the old one cannot be reused
  connection.connect(function(err) {              // The server is either down
    if(err) {                                     // or restarting (takes a while sometimes).
      console.log('error when connecting to db:', err);
      setTimeout(handleDisconnect, 2000); // We introduce a delay before attempting to reconnect,
    }                                     // to avoid a hot loop, and to allow our node script to
  });                                     // process asynchronous requests in the meantime.
                                          // If you're also serving http, display a 503 error.
  connection.on('error', function(err) {
    console.log('db error', err);
    if(err.code === 'PROTOCOL_CONNECTION_LOST') { // Connection to the MySQL server is usually
      handleDisconnect();                         // lost due to either server restart, or a
    } else {                                      // connnection idle timeout (the wait_timeout
      throw err;                                  // server variable configures this)
    }
  });

  return connection;
}

 
 
 function  selectFun(client,username,callback){
	connection.connect(function(err) {
		if(err) {
			console.log('error when connecting to db:', err);
			setTimeout(handleDisconnect, 2000);
		}
	});  
     client.query('select password from userinfo where username="'+username+'"',function(err,results,fields){
         if(err) throw err;
 
         callback(results);
     });
 }
 
 function insertFun(client , username , password, phoneNum, callback){
     client.query('insert into userinfo value(?,?,?,?)', [null,username, password,phoneNum], function(err,result){
         if( err ){
             console.log( "error:" + err.message);
             return err;
         }
           callback(err);
     });
 }

 function searchStory(client, tag, callback) {
    client.query('select name, url from storysearch where tag="' + tag + '"', function(err, results, fields) {
	if(err) throw err;
      callback(results);
    });
 }
 
 exports.connect = connectServer;
 exports.selectFun  = selectFun;
 exports.insertFun = insertFun;
 exports.searchStory = searchStory;